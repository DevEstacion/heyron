<!DOCTYPE html>
<html lang="{{ site.LanguageCode }}"
  x-data
  :class="$store.darkMode.class()"
  :data-theme="$store.darkMode.theme()">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ block "title" . -}} {{ T "home" }} {{- end }} | {{ site.Title }}</title>

    {{ partial "head.html" . }}

    {{ block "css" . }} {{ end }}

    {{ range site.Params.Advanced.customCSS }}
    <link rel="stylesheet" href="{{ . | relURL }}" />
    {{ end }}

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.1/dist/cdn.min.js" integrity="sha256-Rmqrc5SKeSLTSnQ9shSKWmJco1ks8c1hLI8UG2Np03M=" crossorigin="anonymous"></script>
  </head>

  <body x-data="{
    flip: false,
  }">
    <!-- If backgroundImage defined -->
    <div id="dream-global-bg"></div>

    {{ partial "nav.html" . }}

    <div class="flip-container" :class="{ 'flip-it': flip }">
      <div class="flipper">
        <div class="front">
          <div class="container">
            {{ block "main" . }} {{ end }}

            {{ partial "footer.html" . }}
          </div>
        </div>
        <div class="back">
          <div class="container">
            {{ if site.Params.zenMode }}
            {{ partial "zen-back.html" . }}
            {{ else }}
            {{ partial "back.html" . }}
            {{ end }}

            {{ partial "footer.html" . }}
          </div>
        </div>
      </div>
    </div>

    {{ partial "scripts.html" . }}
    {{ block "js" . }} {{ end }}

    {{ range site.Params.Advanced.customJS }}
    <script defer src="{{ . | relURL }}"></script>
    {{ end }}

    {{ if .Store.Get "hasMermaid" }}
      <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.esm.min.mjs';

        // Convert OKLCH/CSS color to hex format that Mermaid understands
        function colorToHex(colorValue) {
          if (colorValue.startsWith('#')) {
            return colorValue;
          }

          const temp = document.createElement('div');
          temp.style.color = colorValue;
          document.body.appendChild(temp);
          const computed = getComputedStyle(temp).color;
          document.body.removeChild(temp);

          const match = computed.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
          if (match) {
            const r = parseInt(match[1]).toString(16).padStart(2, '0');
            const g = parseInt(match[2]).toString(16).padStart(2, '0');
            const b = parseInt(match[3]).toString(16).padStart(2, '0');
            return `#${r}${g}${b}`;
          }

          return '#808080';
        }

        // Get theme colors dynamically from CSS variables and convert to hex
        function getThemeColors() {
          const style = getComputedStyle(document.documentElement);
          const bgColor = style.getPropertyValue('--color-base-100').trim();
          const isDark = bgColor.includes('oklch') && parseFloat(bgColor.match(/oklch\((\d+(?:\.\d+)?)/)?.[1] || 100) < 50;
          const textColor = isDark ? '#ffffff' : '#1f1e1e';

          return {
            theme: 'base',
            themeVariables: {
              primaryColor: '#f5f1ed',
              primaryTextColor: textColor,
              primaryBorderColor: colorToHex(style.getPropertyValue('--color-primary').trim()),
              secondaryColor: '#dad2bc',
              secondaryTextColor: textColor,
              tertiaryColor: '#a99985',
              tertiaryTextColor: textColor,
              lineColor: colorToHex(style.getPropertyValue('--color-primary').trim()),
              textColor: colorToHex(style.getPropertyValue('--color-base-content').trim()),
              mainBkg: colorToHex(style.getPropertyValue('--color-base-100').trim()),
              secondBkg: colorToHex(style.getPropertyValue('--color-base-200').trim()),
              nodeBorder: colorToHex(style.getPropertyValue('--color-primary').trim()),
              nodeTextColor: textColor,
              labelTextColor: colorToHex(style.getPropertyValue('--color-base-content').trim()),
              labelBackgroundColor: colorToHex(style.getPropertyValue('--color-base-100').trim()),
              clusterBkg: colorToHex(style.getPropertyValue('--color-base-200').trim()),
              clusterBorder: colorToHex(style.getPropertyValue('--color-base-300').trim()),
              titleColor: colorToHex(style.getPropertyValue('--color-base-content').trim()),
              edgeLabelBackground: colorToHex(style.getPropertyValue('--color-base-100').trim())
            }
          };
        }

        function renderMermaidDiagrams() {
          const diagrams = document.querySelectorAll('.mermaid');
          diagrams.forEach(el => {
            el.removeAttribute('data-processed');
            if (!el.dataset.diagram) {
              el.dataset.diagram = el.textContent;
            }
            el.textContent = el.dataset.diagram;
            el.classList.add('mermaid-is-rendering');
          });

          return mermaid.run({ querySelector: '.mermaid' }).finally(() => {
            diagrams.forEach(el => {
              el.classList.remove('mermaid-is-rendering');
            });
          });
        }

        function onRenderComplete() {
          if (window.enableMermaidPanZoom) {
            window.enableMermaidPanZoom();
          }
          document.dispatchEvent(new CustomEvent('mermaid:rendered'));
        }

        mermaid.initialize({
          startOnLoad: false,
          ...getThemeColors()
        });

        renderMermaidDiagrams().then(onRenderComplete).catch(onRenderComplete);

        document.addEventListener('alpine:initialized', () => {
          Alpine.effect(() => {
            mermaid.initialize({
              startOnLoad: false,
              ...getThemeColors()
            });

            renderMermaidDiagrams().then(onRenderComplete).catch(onRenderComplete);
          });
        });
      </script>
    {{ end }}

    {{ if .Store.Get "hasMathjax" }}
      {{ partialCached "mathjax.html" . }}
    {{ end }}

    {{ if site.Config.Services.GoogleAnalytics.ID }}
    {{ template "_internal/google_analytics.html" . }}
    {{ end }}

    <script type="module" src="https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.esm.js" integrity="sha256-/IFmi82bIhdYWctu0UddSlJqpnzWm7Vh2C4CM32wF/k=" crossorigin="anonymous"></script>
    <script nomodule defer src="https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.js" integrity="sha256-mr7eJMX3VC3F7G32mk4oWp1C6a2tlMYxUdptfT7uKI8=" crossorigin="anonymous"></script>
  </body>
</html>
