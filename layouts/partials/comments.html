<div id="giscus-comments"></div>
<script>
  (function() {
    {{ $lightCSS := resources.Get "css/giscus-light.css" | minify | fingerprint }}
    {{ $darkCSS := resources.Get "css/giscus-dark.css" | minify | fingerprint }}

    const LIGHT_THEME = '{{ $lightCSS.Permalink }}';
    const DARK_THEME = '{{ $darkCSS.Permalink }}';

    const getThemeURL = (isDark) => isDark ? DARK_THEME : LIGHT_THEME;

    const isDarkMode = () => {
      const stored = localStorage.getItem('hugo-theme-dream-is-dark');
      if (stored === 'y') return true;
      if (stored === 'n') return false;
      return window.matchMedia?.('(prefers-color-scheme: dark)').matches;
    };

    // Create and inject Giscus script with correct initial theme
    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    Object.entries({
      'data-repo': 'DevEstacion/heyron',
      'data-repo-id': 'R_kgDOQsC06g',
      'data-category': 'Comments',
      'data-category-id': 'DIC_kwDOQsC06s4C0DSl',
      'data-mapping': 'pathname',
      'data-strict': '0',
      'data-reactions-enabled': '1',
      'data-emit-metadata': '0',
      'data-input-position': 'top',
      'data-theme': getThemeURL(isDarkMode()),
      'data-lang': 'en',
      'data-loading': 'lazy',
      'crossorigin': 'anonymous'
    }).forEach(([key, value]) => script.setAttribute(key, value));
    script.async = true;
    document.getElementById('giscus-comments').appendChild(script);

    // Listen for theme changes after Alpine initializes
    document.addEventListener('alpine:initialized', () => {
      Alpine.effect(() => {
        const theme = getThemeURL(Alpine.store('darkMode').isDark());

        // Wait for iframe to be ready before sending theme update
        const sendTheme = () => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (iframe) {
            iframe.contentWindow.postMessage(
              { giscus: { setConfig: { theme } } },
              'https://giscus.app'
            );
            return true;
          }
          return false;
        };

        // Try immediately, then retry if needed
        if (!sendTheme()) {
          let attempts = 0;
          const interval = setInterval(() => {
            if (sendTheme() || ++attempts >= 50) {
              clearInterval(interval);
            }
          }, 100);
        }
      });
    });
  })();
</script>
