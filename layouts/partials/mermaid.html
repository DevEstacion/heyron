<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.4.1/dist/mermaid.esm.min.mjs';

  // Theme configuration for emerald (light mode)
  const emeraldConfig = {
    theme: 'base',
    themeVariables: {
      primaryColor: '#10b981',
      primaryTextColor: '#064e3b',
      primaryBorderColor: '#047857',
      secondaryColor: '#d1fae5',
      secondaryTextColor: '#047857',
      secondaryBorderColor: '#059669',
      tertiaryColor: '#ecfdf5',
      tertiaryTextColor: '#065f46',
      tertiaryBorderColor: '#10b981',
      mainBkg: '#ffffff',
      secondBkg: '#f9fafb',
      tertiaryBkg: '#ecfdf5',
      lineColor: '#047857',
      border1: '#d1d5db',
      border2: '#059669',
      textColor: '#1f2937',
      labelTextColor: '#064e3b',
      nodeBkg: '#ffffff',
      nodeTextColor: '#1f2937',
      nodeBorder: '#047857',
      clusterBkg: '#f9fafb',
      clusterBorder: '#d1d5db',
      actorBorder: '#047857',
      actorBkg: '#ecfdf5',
      actorTextColor: '#064e3b',
      signalColor: '#047857',
      signalTextColor: '#1f2937',
      labelBoxBkgColor: '#ecfdf5',
      labelBoxBorderColor: '#047857',
      relationColor: '#047857',
      entityBkgColor: '#ffffff',
      entityBorder: '#047857',
      git0: '#10b981',
      git1: '#059669',
      git2: '#047857',
      git3: '#065f46',
      git4: '#064e3b',
      pie1: '#10b981',
      pie2: '#d1fae5',
      pie3: '#059669',
      pie4: '#ecfdf5',
      pie5: '#047857',
      pie6: '#065f46',
      pie7: '#064e3b',
      pie8: '#6b7280',
      pie9: '#9ca3af',
      pie10: '#d1d5db',
      pie11: '#e5e7eb',
      pie12: '#f9fafb'
    }
  };

  // Theme configuration for forest (dark mode)
  const forestConfig = {
    theme: 'base',
    themeVariables: {
      primaryColor: '#238636',
      primaryTextColor: '#e8e8e8',
      primaryBorderColor: '#2ea043',
      secondaryColor: '#1a3b2a',
      secondaryTextColor: '#e8e8e8',
      secondaryBorderColor: '#3fb950',
      tertiaryColor: '#0d1117',
      tertiaryTextColor: '#8b949e',
      tertiaryBorderColor: '#30363d',
      mainBkg: '#1a1a1a',
      secondBkg: '#0d1117',
      tertiaryBkg: '#21262d',
      lineColor: '#2ea043',
      border1: '#30363d',
      border2: '#3fb950',
      textColor: '#e8e8e8',
      labelTextColor: '#e8e8e8',
      nodeBkg: '#1a1a1a',
      nodeTextColor: '#e8e8e8',
      nodeBorder: '#2ea043',
      clusterBkg: '#0d1117',
      clusterBorder: '#30363d',
      actorBorder: '#2ea043',
      actorBkg: '#1a1a1a',
      actorTextColor: '#e8e8e8',
      signalColor: '#2ea043',
      signalTextColor: '#e8e8e8',
      labelBoxBkgColor: '#1a1a1a',
      labelBoxBorderColor: '#2ea043',
      relationColor: '#2ea043',
      entityBkgColor: '#1a1a1a',
      entityBorder: '#2ea043',
      git0: '#7ee787',
      git1: '#3fb950',
      git2: '#2ea043',
      git3: '#238636',
      git4: '#1a3b2a',
      pie1: '#7ee787',
      pie2: '#3fb950',
      pie3: '#2ea043',
      pie4: '#238636',
      pie5: '#1a3b2a',
      pie6: '#30363d',
      pie7: '#21262d',
      pie8: '#8b949e',
      pie9: '#6e7681',
      pie10: '#0d1117',
      pie11: '#1a1a1a',
      pie12: '#e8e8e8'
    }
  };

  // Wait for Alpine.js to initialize
  document.addEventListener('alpine:initialized', () => {
    // Initialize with current theme
    const isDark = Alpine.store('darkMode').isDark();
    mermaid.initialize({
      startOnLoad: true,
      ...(isDark ? forestConfig : emeraldConfig)
    });

    // Watch for theme changes and re-render diagrams
    Alpine.effect(() => {
      const isDark = Alpine.store('darkMode').isDark();

      // Re-initialize with new theme
      mermaid.initialize({
        startOnLoad: false,
        ...(isDark ? forestConfig : emeraldConfig)
      });

      // Re-render all mermaid diagrams
      const diagrams = document.querySelectorAll('.mermaid');
      diagrams.forEach(element => {
        // Remove processed attribute to allow re-rendering
        element.removeAttribute('data-processed');
        // Store original content if not already stored
        if (!element.dataset.originalContent) {
          element.dataset.originalContent = element.textContent;
        } else {
          // Restore original content for re-processing
          element.textContent = element.dataset.originalContent;
        }
      });

      // Run mermaid on all diagrams
      if (diagrams.length > 0) {
        mermaid.run();
      }
    });
  });
</script>
